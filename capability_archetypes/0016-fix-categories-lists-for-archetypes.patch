From 477d768de0316ce1a421074087dbf1dcb87abfe5 Mon Sep 17 00:00:00 2001
From: Benjamin Kampmann <ben.kampmann@gmail.com>
Date: Mon, 19 May 2014 12:43:02 +0200
Subject: [PATCH 16/18] fix categories lists for archetypes

---
 .../discourse/controllers/navigation_default_controller.js   |  2 +-
 .../javascripts/discourse/routes/application_routes.js       | 12 +++---------
 .../discourse/routes/discovery_categories_route.js           |  3 ++-
 3 files changed, 6 insertions(+), 11 deletions(-)

diff --git a/app/assets/javascripts/discourse/controllers/navigation_default_controller.js b/app/assets/javascripts/discourse/controllers/navigation_default_controller.js
index e7ff32a..cf41d8d 100644
--- a/app/assets/javascripts/discourse/controllers/navigation_default_controller.js
+++ b/app/assets/javascripts/discourse/controllers/navigation_default_controller.js
@@ -27,7 +27,7 @@ Discourse.NavigationCategoryController = Discourse.NavigationDefaultController.e
       args.archetype = this.get("archetype");
     }
     return Discourse.NavItem.buildList(this.get('category'), args);
-  }.property('category', 'noSubcategories')
+  }.property('category', 'noSubcategories', 'archetype')
 });
 
 Discourse.NavigationCategoriesController = Discourse.NavigationDefaultController.extend({});
diff --git a/app/assets/javascripts/discourse/routes/application_routes.js b/app/assets/javascripts/discourse/routes/application_routes.js
index 00e8fd7..0d96b1e 100644
--- a/app/assets/javascripts/discourse/routes/application_routes.js
+++ b/app/assets/javascripts/discourse/routes/application_routes.js
@@ -75,15 +75,9 @@ Discourse.Route.buildRoutes(function() {
     router.resource('arch' + arch.id, {path: '/' + arch.slug}, discoverer);
 
     discoveryRoutes.forEach(function(route){
-      var router = Discourse["Discovery" + route];
-      if (route === ""){
-        // for main, we want it to set the other filter to our
-        // archetype
-        router = router.extend({
-            archetype_filter: arch.id
-        });
-      }
-      Discourse['Arch' + arch.id + route] = router;
+      Discourse['Arch' + arch.id + route] = Discourse["Discovery" + route].extend({
+          archetype_filter: arch.id
+      });
     });
     discoveryTemplates.forEach(function(tmpl){
         Ember.TEMPLATES['arch' + arch.id + tmpl] = Ember.TEMPLATES["discovery" + tmpl];
diff --git a/app/assets/javascripts/discourse/routes/discovery_categories_route.js b/app/assets/javascripts/discourse/routes/discovery_categories_route.js
index 42d2cfc..94c3314 100644
--- a/app/assets/javascripts/discourse/routes/discovery_categories_route.js
+++ b/app/assets/javascripts/discourse/routes/discovery_categories_route.js
@@ -7,13 +7,14 @@
   @module Discourse
 **/
 Discourse.DiscoveryCategoriesRoute = Discourse.Route.extend({
+  controllerName: 'discovery/categories',
   renderTemplate: function() {
     this.render('navigation/categories', { outlet: 'navigation-bar' });
     this.render('discovery/categories', { outlet: 'list-container' });
   },
 
   beforeModel: function() {
-    this.controllerFor('navigationCategories').set('filterMode', 'categories');
+    this.controllerFor('navigationCategories').setProperties({filterMode: 'categories', archetype: this.get("archetype_filter")});
   },
 
   model: function() {
-- 
1.8.3.4 (Apple Git-47)

